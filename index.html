<!DOCTYPE html>

<!--
  COLLABORATORS:
  I did not collaborate with anybody
-->
<html>

<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>Checkerboard</title>

<!-- Load style sheets -->
<link rel="stylesheet" type="text/css" href="mainLayout.css" />

<!-- Load any supplemental Javascript libraries here -->
<script type="text/javascript" src="external_js/jquery-1.9.0.min.js"></script>
<script type="text/javascript" src="checker.js"></script>
<script type="text/javascript" src="boardEvent.js"></script>
<script type="text/javascript" src="board.js"></script>
<script type="text/javascript" src="rules.js"></script>

<script type="text/javascript">

//This script extracts parameters from the URL
//from jquery-howto.blogspot.com

    $.extend({
        getUrlVars : function() {
            var vars = [], hash;
            var hashes = window.location.href.slice(
                    window.location.href.indexOf('?') + 1).split('&');
            for ( var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        },
        getUrlVar : function(name) {
            return $.getUrlVars()[name];
        }
    });

    var DEFAULT_BOARD_SIZE = 8;
    var CANVAS_DIMENSION = 400;
    var COLOR_BLACK = "rgb(100,100,100)";
    var COLOR_WHITE = "rgb(235,235,235)";
    var COLOR_YELLOW = "rgb(255,255,0)";
    var BLACK_KING_URL = "graphics/black-king.png";
    var RED_KING_URL = "graphics/red-king.png";
    var RED_URL = "graphics/red-piece.png";
    var BLACK_URL = "graphics/black-piece.png";

    //canvas for checkers
    var ctx;
    var canvasTop;
    var canvasLeft;

    //canvas for arrows
    var arrowctx;

    //data model
    var board;
    var rules;
    var whoseTurn = "black";


    var directionOf = function(color) {
      if (color == "black") {
        return -1;
      }
      return 1;
    }




    // Fill in this function to toggle the display for whose turn
    // The color parameter should be either "black" or "red"
    var toggleTurn = function() {
        if(whoseTurn == "black"){
            whoseTurn = "red";
        }else{
            whoseTurn = "black";
        }
        changeTurnLabelColorTo(whoseTurn);
    }

    function changeTurnLabelColorTo(color){
        if(color == "red"){
            $("#lblCurrentTurn").removeClass("blackBackground");
            $("#lblCurrentTurn").addClass("redBackground");
            $("#lblCurrentTurn").text("Red Move");
        }else{
            $("#lblCurrentTurn").removeClass("redBackground");
            $("#lblCurrentTurn").addClass("blackBackground");
            $("#lblCurrentTurn").text("Black Move");
        }
    }


    // This allows the Javascript code inside this block to only run when the page
    // has finished loading in the browser.
    $(document).ready(function() {

        ctx = document.getElementById("canvasCheckerboard").getContext("2d");
        var offset = $("#canvasCheckerboard").offset();
        canvasTop = offset.top;
        canvasLeft = offset.left;
        arrowctx = document.getElementById("canvasArrow").getContext("2d");
        $("#canvasArrow").offset(offset).css("visibility","visible");
        if ($.getUrlVar('size') && $.getUrlVar('size') >= 6) {
            board = new Board($.getUrlVar('size'));
        } else {
            board = new Board(DEFAULT_BOARD_SIZE);
        }


	   rules = new Rules(board);


     	// Your code here

        board.addEventListener('add',function (e) {
    		// Your code here
    	},true);

    	board.addEventListener('move',function (e) {
    		// Your code here
    	},true);

        board.addEventListener('remove', function(e) {
        	// Your code here
        }, true);

        board.addEventListener('promote',function (e) {
    		// Your code here
    	},true);

        
        $("#btnNewGame").click(function(evt) {
            board.prepareNewGame();
            drawCanvas();
            toggleTurn("red");
            arrowctx.clearRect(0,0,CANVAS_DIMENSION-10, CANVAS_DIMENSION-10);
        });

        $("#btnAutoMove").click(function(evt) {
          var playerColor = whoseTurn;
          var playerDirection = directionOf(playerColor);
          var result = rules.makeRandomMove(playerColor, playerDirection);
          if (result != null) {
            toggleTurn();
          }
          drawCanvas();
          drawArrow(arrowctx, result.to_col, result.to_row, result.from_col, result.from_row);
        });

        board.prepareNewGame();
        drawCanvas();
    });

    function drawCanvas(){
        var originalFillStyle = ctx.fillStyle;
        var fillStyles = [COLOR_WHITE, COLOR_BLACK];
        var squareDimension = CANVAS_DIMENSION/board.boardSize;
        
        var checker;
        var image;
        $(".checkerPiece").remove();
        for(var i = 0; i < board.boardSize; i++){
            for(var j = 0; j < board.boardSize; j++){
                ctx.fillStyle = fillStyles[(i+j)%2];
                ctx.fillRect(i*squareDimension, j*squareDimension, squareDimension, squareDimension);
                checker = board.getCheckerAt(i,j);
                if(checker){
                    image = $("<img class='checkerPiece' width='" + squareDimension + "' height='"+squareDimension+"'></img>");
                    if(checker.color == "red" && checker.isKing){
                        image.attr("src",RED_KING_URL);
                    }else if(checker.color == "black" && checker.isKing){
                        image.attr("src",BLACK_KING_URL);
                    }else if(checker.color == "red" && !checker.isKing){
                        image.attr("src",RED_URL);
                    }else if(checker.color == "black" && !checker.isKing){
                        image.attr("src",BLACK_URL);
                    }
                    image.css({position:"absolute", top:canvasTop+squareDimension*i,left:canvasLeft+squareDimension*j});
                    image.appendTo("#content");
                }
            }
        }
        ctx.fillStyle = originalFillStyle;
    }

    function drawArrow(context, to_col, to_row, from_col, from_row){
        context.clearRect(0,0,CANVAS_DIMENSION-10, CANVAS_DIMENSION-10);
        context.strokeStyle = COLOR_YELLOW;
        context.lineWidth=2;
        var originalFillStyle = context.fillStyle;
        context.strokeStyle = COLOR_YELLOW;
        var squareDimension = CANVAS_DIMENSION/board.boardSize;
        var tox = to_col*squareDimension + squareDimension/2;
        var toy = to_row*squareDimension + squareDimension/2;
        var fromx = from_col*squareDimension + squareDimension/2;
        var fromy = from_row*squareDimension + squareDimension/2;
        
        var headlen = 10;   // length of head in pixels
        var angle = Math.atan2(toy-fromy,tox-fromx);
        context.beginPath();
        context.moveTo(fromx, fromy);
        context.lineTo(tox, toy);
        context.lineTo(tox-headlen*Math.cos(angle-Math.PI/6),toy-headlen*Math.sin(angle-Math.PI/6));
        context.moveTo(tox, toy);
        context.lineTo(tox-headlen*Math.cos(angle+Math.PI/6),toy-headlen*Math.sin(angle+Math.PI/6));
        context.closePath();
        context.stroke();
        context.fillStyle = originalFillStyle;
    }

</script>


</head>

<body>

<table id="mainTable">
    <tr>
        <td id="navigation">
          <table>
			  <tr><td>		<p id="lblCurrentTurn" class="blackBackground">Black Move</p>		</td></tr>
              <tr><td><input id="btnNewGame" type="button" name="new" value="New Game"/></td></tr>
              <tr><td><input id="btnAutoMove" type="button" name="new" value="Auto Move"/></td></tr>

            </table>
        </td>

        <td id="content">
            <canvas id="canvasCheckerboard" width="400" height="400"></canvas>
            <canvas id="canvasArrow" width="400" height="400" visibility="none"></canvas>
        </td>
    </tr>

   </table>

</body>

</html>
